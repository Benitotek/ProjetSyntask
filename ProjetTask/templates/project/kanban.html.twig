{% extends 'base.html.twig' %}

{% block title %}
	{{ project.nom }}
	- Kanban
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('css/project-management.css') }}">
	<link rel="stylesheet" href="{{ asset('CSS/kanban.css') }}">
{% endblock %}

{% block body %}
	<div
		class="app-container">
		<!-- Sidebar -->
		<aside class="sidebar sidebar-collapsed" id="sidebar">
			<div class="sidebar-toggle" id="sidebarToggle">
				<i class="icon-menu"></i>
			</div>

			<div class="sidebar-header">
				<div class="app-logo">
					<div class="logo-placeholder">
						<i class="icon-image"></i>
					</div>
					<span class="logo-text">logo de l'application</span>
				</div>
			</div>

			<nav class="sidebar-nav">
				<ul class="nav-menu">
					<li class="nav-item">
						<a href="{{ path('employe_dashboard') }}" class="nav-link">
							<i class="icon-dashboard"></i>
							<span class="nav-text">Tableau de bord</span>
						</a>
					</li>
					<li class="nav-item active">
						<a href="{{ path('mes_projets') }}" class="nav-link">
							<i class="icon-projects"></i>
							<span class="nav-text">Mes projets</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="{{ path('statistiques') }}" class="nav-link">
							<i class="icon-stats"></i>
							<span class="nav-text">Statistiques</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="{{ path('mon_profil') }}" class="nav-link">
							<i class="icon-profile"></i>
							<span class="nav-text">Mon profil</span>
						</a>
					</li>
				</ul>
			</nav>
		</aside>

		<!-- Contenu principal Kanban -->
		<main
			class="main-content kanban-main">
			<!-- Header du projet -->
			<div class="kanban-header">
				<div class="project-info">
					<h1 class="project-title">{{ project.nom }}</h1>
					<span class="project-status project-status-{{ project.statut|lower|replace({'-': '_'}) }}">
						{{ project.statut|replace({'-': ' '})|title }}
					</span>
				</div>

				<div class="kanban-actions">
					<button class="btn btn-secondary btn-sm" id="addColumnBtn">
						<i class="icon-plus"></i>
						Ajouter colonne
					</button>
					<button class="btn btn-primary btn-sm" id="addTaskBtn">
						<i class="icon-plus"></i>
						Nouvelle tâche
					</button>
					<a href="{{ path('project_show', {'id': project.id}) }}" class="btn btn-outline btn-sm">
						<i class="icon-settings"></i>
						Paramètres
					</a>
				</div>
			</div>

			<!-- Tableau Kanban -->
			<div class="kanban-board" id="kanbanBoard">
				{% for taskList in project.taskLists %}
					<div class="kanban-column" data-column-id="{{ taskList.id }}">
						<div class="column-header">
							<div class="column-title-container">
								<h3 class="column-title" contenteditable="true" data-column-id="{{ taskList.id }}">
									{{ taskList.nom }}
								</h3>
								<span class="task-count">{{ taskList.tasks|length }}</span>
							</div>
							<div class="column-actions">
								<button class="btn-icon" onclick="addTask({{ taskList.id }})" title="Ajouter une tâche">
									<i class="icon-plus"></i>
								</button>
								<div class="dropdown">
									<button class="btn-icon dropdown-toggle" title="Options">
										<i class="icon-more"></i>
									</button>
									<div class="dropdown-menu">
										<a href="#" onclick="editColumn({{ taskList.id }})">Modifier</a>
										<a href="#" onclick="deleteColumn({{ taskList.id }})">Supprimer</a>
									</div>
								</div>
							</div>
						</div>

						<div class="tasks-container" data-column-id="{{ taskList.id }}">
							{% for task in taskList.tasks %}
								<div class="task-card" data-task-id="{{ task.id }}" data-column-id="{{ taskList.id }}" draggable="true">
									<div class="task-header">
										<h4 class="task-title">{{ task.titre }}</h4>
										{% if task.priorite %}
											<span class="priority-badge priority-{{ task.priorite|lower }}">
												{{ task.priorite }}
											</span>
										{% endif %}
									</div>

									{% if task.description %}
										<p class="task-description">
											{{ task.description|slice(0, 100) }}
											{% if task.description|length > 100 %}...
											{% endif %}
										</p>
									{% endif %}

									<div class="task-meta">
										{% if task.dateButoir %}
											<div class="task-due-date {% if task.dateButoir < date() and task.statut != 'TERMINE' %}overdue{% endif %}">
												<i class="icon-calendar"></i>
												{{ task.dateButoir|date('d/m') }}
											</div>
										{% endif %}

										{% if task.assignedUsers|length > 0 %}
											<div class="task-assignees">
												{% for user in task.assignedUsers|slice(0, 3) %}
													<div class="assignee-avatar" title="{{ user.username }}">
														{{ user.username|slice(0, 2)|upper }}
													</div>
												{% endfor %}
												{% if task.assignedUsers|length > 3 %}
													<div class="assignee-avatar more">
														+{{ task.assignedUsers|length - 3 }}
													</div>
												{% endif %}
											</div>
										{% endif %}
									</div>

									{% if task.commentaires is defined and task.commentaires|length > 0 %}
										<div class="task-indicators">
											<span class="indicator">
												<i class="icon-comment"></i>
												{{ task.commentaires|length }}
											</span>
										</div>
									{% endif %}
								</div>
							{% endfor %}

							<!-- Zone de drop pour les tâches -->
							<div class="task-drop-zone" data-column-id="{{ taskList.id }}">
								Glisser une tâche ici
							</div>
						</div>
					</div>
				{% endfor %}

				<!-- Bouton pour ajouter une colonne -->
				<div class="add-column-placeholder" id="addColumnPlaceholder">
					<button class="add-column-btn" onclick="showAddColumnForm()">
						<i class="icon-plus"></i>
						Ajouter une colonne
					</button>
				</div>
			</div>
		</main>
	</div>

	<!-- Modal pour ajouter/modifier une tâche -->
	<div class="modal" id="taskModal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 id="taskModalTitle">Nouvelle tâche</h3>
				<button class="modal-close" onclick="closeTaskModal()">×</button>
			</div>
			<form id="taskForm">
				<div class="form-group">
					<label for="taskTitle">Titre de la tâche</label>
					<input type="text" id="taskTitle" name="titre" class="form-input" required>
				</div>

				<div class="form-group">
					<label for="taskDescription">Description</label>
					<textarea id="taskDescription" name="description" class="form-textarea" rows="3"></textarea>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label for="taskPriority">Priorité</label>
						<select id="taskPriority" name="priorite" class="form-select">
							<option value="">Aucune</option>
							<option value="FAIBLE">Faible</option>
							<option value="NORMALE">Normale</option>
							<option value="HAUTE">Haute</option>
							<option value="URGENTE">Urgente</option>
						</select>
					</div>

					<div class="form-group">
						<label for="taskDueDate">Date d'échéance</label>
						<input type="date" id="taskDueDate" name="dateButoir" class="form-input">
					</div>
				</div>

				<div class="form-group">
					<label for="taskAssignees">Assigné à</label>
					<select id="taskAssignees" name="assignedUsers[]" class="form-select" multiple>
						{% for membre in project.membres %}
							<option value="{{ membre.id }}">{{ membre.username }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="modal-actions">
					<button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Annuler</button>
					<button type="submit" class="btn btn-primary">Sauvegarder</button>
				</div>

				<input type="hidden" id="taskId" name="id">
				<input type="hidden" id="taskColumnId" name="taskListId">
			</form>
		</div>
	</div>

	<!-- Modal pour ajouter une colonne -->
	<div class="modal" id="columnModal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Nouvelle colonne</h3>
				<button class="modal-close" onclick="closeColumnModal()">×</button>
			</div>
			<form id="columnForm">
				<div class="form-group">
					<label for="columnName">Nom de la colonne</label>
					<input type="text" id="columnName" name="nom" class="form-input" required>
				</div>

				<div class="modal-actions">
					<button type="button" class="btn btn-secondary" onclick="closeColumnModal()">Annuler</button>
					<button type="submit" class="btn btn-primary">Créer</button>
				</div>
			</form>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{ asset('js/kanban.js') }}"></script>
{% endblock %}


<style>
	/* Ajoutez ces styles spécifiques au kanban si nécessaire */
	.kanban-card {
		cursor: pointer;
		transition: all 0.3s ease;
	}
	.kanban-card:hover {
		transform: translateY(-5px);
	}
</style>{% endblock %}{% block javascripts %}
<script>
{% endblock %}
