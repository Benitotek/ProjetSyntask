{% extends 'base.html.twig' %}
{% block stylesheets %}
	{{ parent() }}
	<link	rel="stylesheet"	href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css">
		<link	rel="stylesheet"	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
			<link	rel="stylesheet"	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
				<link	rel="stylesheet"	href="{{ asset('styles/kanban.css') }}">
				{% endblock %}
				{% block head %}
					{{ parent() }}
					<meta	name="description"	content="Kanban board for project {{ project.titre }}. Manage tasks, columns, and team assignments easily.">
						<meta	name="keywords"	content="kanban, project management, tasks, columns, team collaboration">
							<meta	name="author"	content="{{ app.user.fullName }}">
							{% endblock %}
							{% block styles %}
								{{ parent() }}
								<link	rel="stylesheet"	href="{{ asset('styles/kanban.css') }}">
								{% endblock %}
								{% block header %}
									{{ parent() }}
									<h1	class="h3 mb-0">
										Kanban Board for
										{{ project.titre }}
									</h1>
									<p	class="text-muted">
										Manage your tasks and team efficiently.
									</p>
								{% endblock %}
								{% block javascripts %}
									{{ parent() }}
									<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" integrity="" crossorigin="anonymous"></script>
									<script src="{{ asset('js/kanban.js') }}"></script>
								{% endblock %}
								{% block title %}
									Kanban — DASHBOARD
									{% if project.titre is not empty %}
										|
										{{ project.titre }}
									{% endif %}
									{{ project.titre }}
								{% endblock %}
								{% block body %}
									<div	class="container-fluid py-3 kanban-container"	data-project-id="{{ project.id }}"	data-read-only="{{ project.archived ? 'true' : 'false' }}">
										<div	class="kanban-content-wrapper">
											{% if project.archived %}
												<div	class="alert alert-warning d-flex align-items-center"	role="alert">
													<i	class="bi bi-lock me-2"></i>
													Projet archivé — lecture seule
												</div>
											{% endif %}
											<div	class="d-flex justify-content-between align-items-center mb-3">
												<div>
													<nav	aria-label="breadcrumb">
														<ol	class="breadcrumb mb-0">
															<li	class="breadcrumb-item">
																<a	href="{{ path('app_project_index') }}">
																	Projets
																</a>
															</li>
															<li	class="breadcrumb-item active"	aria-current="page">
																{{ project.titre }}
															</li>
														</ol>
													</nav>
													<h1	class="h4 mt-2">
														Kanban
													</h1>
												</div>
												<div	class="d-flex gap-2">
													{% if is_granted('EDIT', project) %}
														<button	class="btn btn-primary"	id="btn-add-column">
															<i	class="bi bi-plus-lg me-1"></i>
															Nouvelle colonne
														</button>
													{% endif %}
													<button	class="btn btn-primary"	data-bs-toggle="modal"	data-bs-target="#modalNewTask">
														<i	class="bi bi-plus-lg me-1"></i>
														Nouvelle tâche
													</button>
												</div>
											</div>
											{# KPIs #}
											{% if kpi is defined %}
												<div	class="row g-3 mb-3">
													<div	class="col-md-4">
														<div	class="card shadow-sm">
															<div	class="card-body d-flex justify-content-between align-items-center">
																<div>
																	<div	class="text-muted small">
																		Tâches terminées
																	</div>
																	<div	class="h5 mb-0">
																		{{ kpi.percentDone }}
																		%
																	</div>
																</div>
																<i	class="bi bi-check-circle text-success fs-3"></i>
															</div>
															<div	class="progress rounded-0"	style="height:6px">
																<div	class="progress-bar"	role="progressbar"	style="width: {{ kpi.percentDone }}%"></div>
															</div>
														</div>
													</div>
													<div	class="col-md-4">
														<div	class="card shadow-sm">
															<div	class="card-body d-flex justify-content-between align-items-center">
																<div>
																	<div	class="text-muted small">
																		Tâches en retard
																	</div>
																	<div	class="h5 mb-0">
																		{{ kpi.overdueCount }}
																	</div>
																</div>
																<i	class="bi bi-exclamation-triangle text-danger fs-3"></i>
															</div>
														</div>
													</div>
													<div	class="col-md-4">
														<div	class="card shadow-sm">
															<div	class="card-body d-flex justify-content-between align-items-center">
																<div>
																	<div	class="text-muted small">
																		Temps de cycle moyen
																	</div>
																	<div	class="h5 mb-0">
																		{{ kpi.avgCycleTime }}
																	</div>
																</div>
																<i	class="bi bi-speedometer2 text-primary fs-3"></i>
															</div>
														</div>
													</div>
												</div>
											{% endif %}
											{# Filtres #}
											<form	id="kanban-filters"	class="row g-2 align-items-end mb-3">
												<div	class="col-md-3">
													<label	class="form-label small text-muted">
														Assigné à
													</label>
													<select	class="form-select"	name="assignee">
														<option	value="">
															Tous
														</option>
														{% for user in assignees ?? [] %}
															<option	value="{{ user.id }}">
																{{ user.fullName }}
															</option>
														{% endfor %}
													</select>
												</div>
												<div	class="col-md-3">
													<label	class="form-label small text-muted">
														Priorité
													</label>
													<select	class="form-select"	name="priorite">
														<option	value="">
															Toutes
														</option>
														<option	value="URGENT">
															Urgent
														</option>
														<option	value="NORMAL">
															Normal
														</option>
														<option	value="EN_ATTENTE">
															En attente
														</option>
													</select>
												</div>
												<div	class="col-md-3">
													<label	class="form-label small text-muted">
														Statut
													</label>
													<select	class="form-select"	name="statut">
														<option	value="">
															Tous
														</option>
														<option	value="EN_ATTENTE">
															En attente
														</option>
														<option	value="EN_COURS">
															En cours
														</option>
														<option	value="TERMINER">
															Terminé
														</option>
													</select>
												</div>
												<div	class="col-md-3">
													<label	class="form-label small text-muted">
														Recherche
													</label>
													<input	class="form-control"	type="text"	name="q"	placeholder="Titre, tag..." />
												</div>
											</form>
											{# Board #}
											<div	class="kanban-board"	role="list"	aria-label="Colonnes Kanban">
												{% for column in columns %}
													{# Couleur: si enum -> .css(), si string -> tel quel #}
													{% set colorHex = column.couleur is object and column.couleur.css is defined ? column.couleur.css() : (column.couleur ?? '#6b7280') %}
													<div	class="kanban-column card shadow-sm"	data-column-id="{{ column.id }}"	style="min-width:320px;">
														<div	class="card-header d-flex align-items-center justify-content-between"	style="border-top: 3px solid {{ colorHex }}">
															<div	class="d-flex align-items-center gap-2">
																<span	class="fw-semibold">
																	{{ column.name }}
																</span>
																<span	class="badge bg-secondary"	data-role="count">
																	{{ column.tasks|length }}
																</span>
															</div>
															{% if is_granted('EDIT', project) %}
																<div	class="d-flex align-items-center gap-2">
																	<button	class="btn btn-sm btn-outline-secondary"	data-handle="column-drag"	aria-label="Déplacer la colonne">
																		<i	class="bi bi-grip-vertical"></i>
																	</button>
																	<div	class="dropdown">
																		<button	class="btn btn-sm btn-outline-secondary"	data-bs-toggle="dropdown"	aria-expanded="false">
																			<i	class="bi bi-three-dots"></i>
																		</button>
																		<ul	class="dropdown-menu dropdown-menu-end">
																			<li>
																				<a	class="dropdown-item"	href="#"	data-action="column:edit"	data-column-id="{{ column.id }}">
																					Renommer
																				</a>
																			</li>
																			<li>
																				<a	class="dropdown-item text-danger"	href="#"	data-action="column:delete"	data-column-id="{{ column.id }}">
																					Supprimer
																				</a>
																			</li>
																		</ul>
																	</div>
																</div>
															{% endif %}
														</div>
														<div	class="card-body p-2">
															<ul	class="kanban-list list-unstyled m-0"	role="list"	aria-label="Tâches"	data-column-id="{{ column.id }}">
																{% for task in column.tasks|sort((a,b) => a.position <=> b.position) %}
																	<li	class="kanban-item card mb-2 shadow-sm"	role="listitem"	data-task-id="{{ task.id }}">
																		<div	class="card-body p-2">
																			<div	class="d-flex align-items-start justify-content-between">
																				<h6	class="card-title mb-1 me-2 {{ task.statut.value == 'TERMINER' ? 'text-decoration-line-through text-muted' : '' }}">
																					{{ task.title ?? task.titre }}
																				</h6>
																				{% if is_granted('EDIT', project) %}
																					<button	class="btn btn-sm btn-outline-secondary"	data-handle="task-drag"	aria-label="Déplacer la tâche">
																						<i	class="bi bi-grip-vertical"></i>
																					</button>
																				{% endif %}
																			</div>
																			<div	class="d-flex flex-wrap align-items-center gap-2">
																				{% if task.assignedUser ?? task.assignee %}
																					{% set user = task.assignedUser ?? task.assignee %}
																					<span	class="badge rounded-pill bg-dark-subtle text-dark"	title="{{ user.fullName }}">
																						{{ user.initials ?? (user.firstname|first ~ user.lastname|first)|upper }}
																					</span>
																				{% else %}
																					<span	class="badge rounded-pill bg-light text-muted">
																						Non assignée
																					</span>
																				{% endif %}
																				<span	class="badge priority-{{ task.priorite.value ?? task.priority.value ?? task.priority }}">
																					{{ task.priorite.label ?? task.priority.label ?? task.priority }}
																				</span>
																				<span	class="badge statut-{{ task.statut.value }}">
																					{{ task.statut.label }}
																				</span>
																				{% if task.dateDeFin ?? task.dateButoir %}
																					{% set dueDate = (task.dateDeFin ?? task.dateButoir) %}
																					{% set now = "now"|date('U') %}
																					{% set due = dueDate|date('U') %}
																					{% set diff = due - now %}
																					{% set dueClass = (task.statut.value != 'TERMINER' and diff < 0) ? 'text-danger' : ((task.statut.value != 'TERMINER' and diff < 606024*3) ? 'text-warning' : 'text-muted') %}
																					<span	class="{{ dueClass }}">
																						<i	class="bi bi-calendar-event me-1"></i>
																						{{ dueDate|date('d/m/Y') }}
																					</span>
																				{% endif %}
																			</div>
																			<div	class="mt-2 d-flex gap-2">
																				<button	class="btn btn-sm btn-outline-secondary btn-task-details"	data-task-id="{{ task.id }}">
																					<i	class="bi bi-eye"></i>
																					Détails
																				</button>
																				{% if is_granted('EDIT', project) %}
																					<button	class="btn btn-sm btn-outline-primary"	data-action="task:edit"	data-task-id="{{ task.id }}">
																						<i	class="bi bi-pencil"></i>
																					</button>
																					<button	class="btn btn-sm btn-outline-success"	data-action="task:statut"	data-task-id="{{ task.id }}"	data-statut="TERMINER"	{{ task.statut.value == 'TERMINER' ? 'disabled' : '' }}	title="Marquer terminé">
																						<i	class="bi bi-check2-circle"></i>
																					</button>
																					<div	class="dropdown">
																						<button	class="btn btn-sm btn-outline-secondary"	data-bs-toggle="dropdown">
																							<i	class="bi bi-three-dots"></i>
																						</button>
																						<ul	class="dropdown-menu">
																							<li>
																								<a	class="dropdown-item"	href="#"	data-action="task:assign"	data-task-id="{{ task.id }}">
																									Assigner
																								</a>
																							</li>
																							<li>
																								<a	class="dropdown-item text-danger"	href="#"	data-action="task:delete"	data-task-id="{{ task.id }}">
																									Supprimer
																								</a>
																							</li>
																						</ul>
																					</div>
																				{% endif %}
																			</div>
																		</div>
																	</li>
																{% else %}
																	<li	class="text-muted small p-2 border rounded border-secondary-subtle">
																		Aucune tâche
																	</li>
																{% endfor %}
															</ul>
														</div>
														{% if is_granted('EDIT', project) %}
															<div	class="card-footer bg-white">
																<button	class="btn btn-sm btn-light w-100"	data-action="task:new"	data-column-id="{{ column.id }}">
																	<i	class="bi bi-plus"></i>
																	Ajouter une carte
																</button>
															</div>
														{% endif %}
													</div>
												{% endfor %}
											</div>
											{# Modals: Détails tâche #}
											<div	class="modal fade"	id="task-details-modal"	tabindex="-1"	aria-hidden="true">
												<div	class="modal-dialog modal-lg modal-dialog-scrollable">
													<div	class="modal-content">
														<div	class="modal-header">
															<h5	class="modal-title">
																Détails
															</h5>
															<button	class="btn btn-close"	data-bs-dismiss="modal"	aria-label="Fermer"></button>
														</div>
														<div	class="modal-body task-details-body"></div>
													</div>
												</div>
											</div>
											{# Modal Nouvelle Tâche #}
											<div	class="modal fade"	id="modalNewTask"	tabindex="-1"	aria-labelledby="modalNewTaskLabel"	aria-hidden="true">
												<div	class="modal-dialog">
													<div	class="modal-content">
														<div	class="modal-header">
															<h5	class="modal-title"	id="modalNewTaskLabel">
																Nouvelle tâche
															</h5>
															<button	type="button"	class="btn-close"	data-bs-dismiss="modal"	aria-label="Fermer"></button>
														</div>
														<div	class="modal-body">
															<form	id="form-new-task">
																<div	class="mb-3">
																	<label	class="form-label">
																		Titre
																	</label>
																	<input	type="text"	name="title"	class="form-control"	required></div>
																	<div	class="mb-3">
																		<label	class="form-label">
																			Priorité
																		</label>
																		<select	name="priorite"	class="form-select">
																			<option	value="NORMAL">
																				Normal
																			</option>
																			<option	value="URGENT">
																				Urgent
																			</option>
																			<option	value="EN_ATTENTE">
																				En attente
																			</option>
																		</select>
																	</div>
																	<div	class="mb-3">
																		<label	class="form-label">
																			Échéance
																		</label>
																		<input	type="date"	name="dateDeFin"	class="form-control"></div>
																	</form>
																</div>
																<div	class="modal-footer">
																	<button	class="btn btn-secondary"	data-bs-dismiss="modal">
																		Annuler
																	</button>
																	<button	class="btn btn-primary"	data-action="task:create">
																		Créer
																	</button>
																</div>
															</div>
														</div>
													</div>
													{# Toasts #}
													<div	class="toast-container position-fixed bottom-0 end-0 p-3"	id="toast-area"	aria-live="polite"	aria-atomic="true"></div>
												</div>
											</div>
										<!-- Fermeture du kanban-content-wrapper -->
										</div>
									{% endblock %}
									{% block javascripts %}
										{{ parent() }}
										<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>
										<script src="{{ asset('js/kanban.js') }}"></script>
									{% endblock %}
									